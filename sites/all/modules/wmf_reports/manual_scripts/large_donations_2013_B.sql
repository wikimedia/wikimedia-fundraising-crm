-- Gave $100 or more since 2009
-- Within 50 miles of NYC (zip 10001)

DROP TABLE IF EXISTS %(scratch)s_condition1;

CREATE table %(scratch)s_condition1
(
    SELECT
        contact_id AS civi_id
    FROM civicrm_contribution
    WHERE
        receive_date > "2009-01-01"
    GROUP BY
        civi_id
    HAVING
        SUM(total_amount) >= 100
);

ALTER TABLE %(scratch)s_condition1 ADD UNIQUE INDEX UI_civi_id (civi_id);

DROP TABLE IF EXISTS %(scratch)s_zips;
CREATE TABLE %(scratch)s_zips
(
    zip int not null,
    unique key zip (zip)
);
INSERT INTO %(scratch)s_zips (zip) VALUES (06430),(06490),(06807),(06820),(06829),(06830),(06831),(06840),(06842),(06850),(06851),(06853),(06854),(06855),(06856),(06858),(06870),(06876),(06877),(06878),(06880),(06883),(06889),(06897),(06901),(06902),(06903),(06905),(06906),(06907),(06910),(06921),(06922),(06926),(07001),(07002),(07003),(07004),(07005),(07006),(07007),(07008),(07009),(07010),(07011),(07012),(07013),(07014),(07015),(07016),(07017),(07018),(07019),(07020),(07021),(07022),(07023),(07024),(07026),(07027),(07028),(07029),(07030),(07031),(07032),(07033),(07034),(07035),(07036),(07039),(07040),(07041),(07042),(07043),(07044),(07045),(07046),(07047),(07050),(07051),(07052),(07054),(07055),(07057),(07058),(07059),(07060),(07061),(07062),(07063),(07064),(07065),(07066),(07067),(07068),(07070),(07071),(07072),(07073),(07074),(07075),(07076),(07077),(07078),(07079),(07080),(07081),(07082),(07083),(07087),(07088),(07090),(07091),(07092),(07093),(07094),(07095),(07096),(07097),(07099),(07101),(07102),(07103),(07104),(07105),(07106),(07107),(07108),(07109),(07110),(07111),(07112),(07114),(07175),(07182),(07184),(07188),(07189),(07191),(07192),(07193),(07194),(07195),(07197),(07198),(07199),(07201),(07202),(07203),(07204),(07205),(07206),(07207),(07208),(07302),(07303),(07304),(07305),(07306),(07307),(07308),(07309),(07310),(07311),(07399),(07401),(07403),(07405),(07407),(07410),(07416),(07417),(07418),(07419),(07420),(07421),(07422),(07423),(07424),(07428),(07430),(07432),(07435),(07436),(07438),(07439),(07440),(07442),(07444),(07446),(07450),(07451),(07452),(07456),(07457),(07458),(07460),(07461),(07462),(07463),(07465),(07470),(07474),(07477),(07480),(07481),(07495),(07498),(07501),(07502),(07503),(07504),(07505),(07506),(07507),(07508),(07509),(07510),(07511),(07512),(07513),(07514),(07522),(07524),(07530),(07533),(07538),(07543),(07544),(07601),(07602),(07603),(07604),(07605),(07606),(07607),(07608),(07620),(07621),(07624),(07626),(07627),(07628),(07630),(07631),(07632),(07640),(07641),(07642),(07643),(07644),(07645),(07646),(07647),(07648),(07649),(07650),(07652),(07653),(07656),(07657),(07660),(07661),(07662),(07663),(07666),(07670),(07675),(07688),(07701),(07702),(07703),(07704),(07709),(07710),(07711),(07712),(07715),(07716),(07717),(07718),(07719),(07720),(07721),(07722),(07723),(07724),(07726),(07727),(07728),(07730),(07731),(07732),(07733),(07734),(07735),(07737),(07738),(07739),(07740),(07746),(07747),(07748),(07750),(07751),(07752),(07753),(07754),(07755),(07756),(07757),(07758),(07760),(07762),(07763),(07764),(07765),(07777),(07799),(07801),(07802),(07803),(07806),(07820),(07821),(07822),(07828),(07830),(07831),(07834),(07836),(07837),(07839),(07840),(07842),(07843),(07845),(07846),(07847),(07848),(07849),(07850),(07852),(07853),(07855),(07856),(07857),(07860),(07863),(07865),(07866),(07869),(07870),(07871),(07874),(07876),(07878),(07879),(07880),(07885),(07890),(07901),(07902),(07920),(07921),(07922),(07924),(07926),(07927),(07928),(07930),(07931),(07932),(07933),(07934),(07935),(07936),(07938),(07939),(07940),(07945),(07946),(07950),(07960),(07961),(07962),(07963),(07970),(07974),(07976),(07977),(07978),(07979),(07980),(07981),(07983),(07999),(08501),(08502),(08504),(08510),(08512),(08514),(08520),(08525),(08526),(08527),(08528),(08535),(08536),(08540),(08541),(08542),(08543),(08544),(08550),(08551),(08553),(08555),(08558),(08561),(08570),(08601),(08602),(08603),(08604),(08605),(08606),(08607),(08619),(08620),(08625),(08645),(08646),(08647),(08648),(08650),(08666),(08677),(08690),(08691),(08695),(08720),(08730),(08736),(08738),(08741),(08750),(08801),(08805),(08807),(08809),(08810),(08812),(08816),(08817),(08818),(08820),(08821),(08822),(08823),(08824),(08826),(08828),(08829),(08830),(08831),(08832),(08833),(08835),(08836),(08837),(08840),(08846),(08850),(08852),(08853),(08854),(08855),(08857),(08858),(08859),(08861),(08862),(08863),(08868),(08869),(08871),(08872),(08873),(08875),(08876),(08877),(08878),(08879),(08880),(08882),(08884),(08885),(08887),(08888),(08889),(08890),(08896),(08899),(08901),(08902),(08903),(08904),(08905),(08906),(08922),(08933),(08988),(08989),(10001),(10002),(10003),(10004),(10005),(10006),(10007),(10008),(10009),(10010),(10011),(10012),(10013),(10014),(10015),(10016),(10017),(10018),(10019),(10020),(10021),(10022),(10023),(10024),(10025),(10026),(10027),(10028),(10029),(10030),(10031),(10032),(10033),(10034),(10035),(10036),(10037),(10038),(10039),(10040),(10041),(10043),(10044),(10045),(10046),(10047),(10048),(10055),(10060),(10069),(10072),(10079),(10080),(10081),(10082),(10087),(10090),(10094),(10095),(10096),(10098),(10099),(10101),(10102),(10103),(10104),(10105),(10106),(10107),(10108),(10109),(10110),(10111),(10112),(10113),(10114),(10115),(10116),(10117),(10118),(10119),(10120),(10121),(10122),(10123),(10124),(10125),(10126),(10128),(10129),(10130),(10131),(10132),(10133),(10138),(10149),(10150),(10151),(10152),(10153),(10154),(10155),(10156),(10157),(10158),(10159),(10160),(10161),(10162),(10163),(10164),(10165),(10166),(10167),(10168),(10169),(10170),(10171),(10172),(10173),(10174),(10175),(10176),(10177),(10178),(10179),(10184),(10185),(10196),(10197),(10199),(10203),(10211),(10212),(10213),(10242),(10249),(10256),(10257),(10258),(10259),(10260),(10261),(10265),(10268),(10269),(10270),(10271),(10272),(10273),(10274),(10275),(10276),(10277),(10278),(10279),(10280),(10281),(10282),(10285),(10286),(10292),(10301),(10302),(10303),(10304),(10305),(10306),(10307),(10308),(10309),(10310),(10311),(10312),(10313),(10314),(10451),(10452),(10453),(10454),(10455),(10456),(10457),(10458),(10459),(10460),(10461),(10462),(10463),(10464),(10465),(10466),(10467),(10468),(10469),(10470),(10471),(10472),(10473),(10474),(10475),(10499),(10501),(10502),(10503),(10504),(10505),(10506),(10507),(10510),(10511),(10514),(10517),(10518),(10519),(10520),(10521),(10522),(10523),(10524),(10526),(10527),(10528),(10530),(10532),(10533),(10535),(10536),(10537),(10538),(10540),(10542),(10543),(10545),(10546),(10547),(10548),(10549),(10550),(10551),(10552),(10553),(10557),(10558),(10559),(10560),(10562),(10566),(10567),(10570),(10571),(10572),(10573),(10576),(10577),(10578),(10579),(10580),(10581),(10583),(10587),(10588),(10589),(10590),(10591),(10592),(10594),(10595),(10596),(10597),(10598),(10601),(10602),(10603),(10604),(10605),(10606),(10607),(10610),(10625),(10629),(10633),(10650),(10701),(10702),(10703),(10704),(10705),(10706),(10707),(10708),(10709),(10710),(10801),(10802),(10803),(10804),(10805),(10901),(10910),(10911),(10912),(10913),(10917),(10920),(10921),(10922),(10923),(10924),(10925),(10926),(10927),(10928),(10930),(10931),(10940),(10941),(10943),(10950),(10952),(10953),(10954),(10956),(10959),(10960),(10962),(10964),(10965),(10968),(10969),(10970),(10974),(10975),(10976),(10977),(10979),(10980),(10981),(10982),(10983),(10984),(10986),(10987),(10989),(10990),(10993),(10994),(10995),(10996),(10997),(10998),(11001),(11002),(11003),(11004),(11005),(11010),(11020),(11021),(11022),(11023),(11024),(11025),(11026),(11027),(11030),(11040),(11041),(11042),(11043),(11044),(11050),(11051),(11052),(11053),(11054),(11055),(11096),(11099),(11101),(11102),(11103),(11104),(11105),(11106),(11109),(11120),(11201),(11202),(11203),(11204),(11205),(11206),(11207),(11208),(11209),(11210),(11211),(11212),(11213),(11214),(11215),(11216),(11217),(11218),(11219),(11220),(11221),(11222),(11223),(11224),(11225),(11226),(11228),(11229),(11230),(11231),(11232),(11233),(11234),(11235),(11236),(11237),(11238),(11239),(11240),(11241),(11242),(11243),(11244),(11245),(11247),(11248),(11249),(11251),(11252),(11254),(11255),(11256),(11351),(11352),(11353),(11354),(11355),(11356),(11357),(11358),(11359),(11360),(11361),(11362),(11363),(11364),(11365),(11366),(11367),(11368),(11369),(11370),(11371),(11372),(11373),(11374),(11375),(11377),(11378),(11379),(11380),(11381),(11385),(11386),(11388),(11390),(11405),(11411),(11412),(11413),(11414),(11415),(11416),(11417),(11418),(11419),(11420),(11421),(11422),(11423),(11424),(11425),(11426),(11427),(11428),(11429),(11430),(11431),(11432),(11433),(11434),(11435),(11436),(11439),(11451),(11484),(11499),(11501),(11507),(11509),(11510),(11514),(11516),(11518),(11520),(11530),(11531),(11535),(11536),(11542),(11545),(11547),(11548),(11549),(11550),(11551),(11552),(11553),(11554),(11555),(11556),(11557),(11558),(11559),(11560),(11561),(11563),(11564),(11565),(11566),(11568),(11569),(11570),(11571),(11572),(11575),(11576),(11577),(11579),(11580),(11581),(11582),(11583),(11588),(11590),(11592),(11593),(11594),(11595),(11596),(11597),(11598),(11599),(11690),(11691),(11692),(11693),(11694),(11695),(11696),(11697),(11701),(11702),(11703),(11704),(11705),(11706),(11709),(11710),(11714),(11716),(11717),(11718),(11721),(11722),(11724),(11725),(11726),(11729),(11730),(11731),(11732),(11735),(11736),(11737),(11740),(11741),(11743),(11746),(11747),(11751),(11752),(11753),(11754),(11755),(11756),(11757),(11758),(11760),(11762),(11765),(11767),(11768),(11769),(11770),(11771),(11773),(11774),(11779),(11780),(11782),(11783),(11787),(11788),(11790),(11791),(11793),(11795),(11796),(11797),(11798),(11801),(11802),(11803),(11804),(11815),(11819),(11853),(11854),(11855),(12518),(12520),(12543),(12549),(12550),(12551),(12552),(12555),(12566),(12586);


DROP TABLE IF EXISTS %(scratch)s_condition2;
CREATE table %(scratch)s_condition2
(
    SELECT
        contact_id AS civi_id
    FROM civicrm_address
    JOIN %(scratch)s_condition1 prev
        ON civicrm_address.contact_id = prev.civi_id
    JOIN %(scratch)s_zips
        ON civicrm_address.postal_code = %(scratch)s_zips.zip
    GROUP BY
        civi_id
);

SELECT
    civi_id,
    civicrm_contact.contact_type AS contact_type,
    civicrm_email.email AS email,
    COALESCE( civicrm_contact.display_name ) AS display_name,
    COALESCE( civicrm_contact.first_name ) AS first_name,
    COALESCE( civicrm_contact.last_name ) AS last_name,
    COALESCE( civicrm_contact.organization_name, org.organization_name ) AS organization_name,
    COALESCE( civicrm_address.street_address ) AS address,
    CONCAT(
        COALESCE( supplemental_address_1, "" ),
        " ",
        COALESCE( supplemental_address_2, "" ),
        " ",
        COALESCE( supplemental_address_3, "" )
    ) AS supplemental_address,
    COALESCE( civicrm_address.city ) AS city,
    COALESCE( civicrm_state_province.abbreviation ) AS state,
    COALESCE( civicrm_country.name ) AS country,
    COALESCE( civicrm_address.postal_code ) AS zip,
    COALESCE( civicrm_phone.phone ) AS phone,
    ( SELECT
        GROUP_CONCAT(
            CONCAT( total_amount, ' on ', receive_date )
            ORDER BY receive_date DESC
            SEPARATOR ' & '
        )
        FROM civicrm_contribution
        WHERE contact_id = civi_id
    ) AS contributions,
    GROUP_CONCAT( civicrm_note.note SEPARATOR '|' ) AS note,
    SUM( COALESCE( civicrm_contact.do_not_email, 0 ) ) > 0 AS do_not_email,
    SUM( COALESCE( civicrm_contact.do_not_phone, 0 ) ) > 0 AS do_not_phone
FROM %(scratch)s_condition2
JOIN civicrm_contact
    ON civicrm_contact.id = civi_id
LEFT JOIN civicrm_email
    ON civi_id = civicrm_email.contact_id
LEFT JOIN civicrm_address
    ON civicrm_address.contact_id = civi_id
LEFT JOIN civicrm_phone
    ON civicrm_phone.contact_id = civi_id
LEFT JOIN civicrm_state_province
    ON civicrm_state_province.id = civicrm_address.state_province_id
LEFT JOIN civicrm_country
    ON civicrm_country.id = civicrm_address.country_id
LEFT JOIN civicrm_relationship
    ON civicrm_relationship.contact_id_a = civi_id
LEFT JOIN civicrm_contact org
    ON org.id = civicrm_relationship.contact_id_b
LEFT JOIN civicrm_note
    ON civicrm_note.entity_id = civi_id AND civicrm_note.entity_table = 'civcrm_contact'
GROUP BY
    civi_id
ORDER BY
    last_name ASC;
